name: Deploy to Server

on:
  release:
    types: [created]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.event.inputs.environment || 'staging' }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up SSH
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.SSH_PRIVATE_KEY }}

      - name: Set up Docker
        uses: docker/setup-buildx-action@v3

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Deploy to server
        run: |
          echo "Deploying to ${{ github.event.inputs.environment || 'staging' }} environment"
          
          # Connect to server and deploy
          ssh -o StrictHostKeyChecking=no ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'EOF'
            set -e
            
            APP_DIR="$HOME/ecommerce-cdc-pipeline"
            BACKUP_DIR="$HOME/backups/$(date +%Y%m%d-%H%M%S)"
            
            echo "=== Starting deployment ==="
            
            # Create backup directory
            mkdir -p $BACKUP_DIR
            
            # Backup existing configuration
            if [ -d "$APP_DIR" ]; then
              echo "Backing up existing configuration..."
              cp -r $APP_DIR/config $BACKUP_DIR/ 2>/dev/null || true
            fi
            
            # Pull latest code
            echo "Pulling latest code..."
            if [ -d "$APP_DIR/.git" ]; then
              cd $APP_DIR
              git fetch origin main
              git reset --hard origin/main
            else
              mkdir -p $APP_DIR
              git clone https://github.com/${{ github.repository }}.git $APP_DIR
              cd $APP_DIR
            fi
            
            # Set executable permissions
            chmod +x run_pipeline.sh cleanup.sh
            
            # Update Docker images
            echo "Updating Docker images..."
            cd $APP_DIR/docker
            
            # Pull all images
            docker-compose pull
            
            # Build any local images
            docker-compose build --no-cache glue-local
            
            # Stop existing services
            echo "Stopping existing services..."
            docker-compose down -v 2>/dev/null || true
            
            # Start services
            echo "Starting services..."
            docker-compose up -d
            
            echo "=== Deployment complete ==="
          EOF

